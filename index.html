<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Trening Tracker Premium 4.3</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
  --bg:#f6f7fb; --card:#fff; --text:#0b1226; --muted:#6b7280; --accent:#2b8aef;
  --accent-2:#7dd3fc; --success:#10b981; --warn:#f59e0b; --error:#ef4444;
}
[data-theme="dark"]{
  --bg:#071022; --card:#071827; --text:#e6eef8; --muted:#9aa9bc; --accent:#4fb3ff;
  --accent-2:#2b8aef; --success:#34d399; --warn:#fbbf24; --error:#f87171;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
html,body{
  max-width:100%;
  overflow-x:hidden;
}
body{
  margin:12px;
  padding-top:env(safe-area-inset-top);
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
h1{font-size:18px;margin:0;font-weight:600}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.input, select, button, textarea{padding:8px;border-radius:10px;border:1px solid rgba(11,18,38,0.06);background:var(--card);color:var(--text)}
textarea{resize:none}
.small{font-size:12px;color:var(--muted)}
.container{display:grid;grid-template-columns:1fr 420px;gap:12px;align-items:start}
.card{background:var(--card);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);}
.workout-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
table{width:100%;border-collapse:collapse}
th,td{padding:6px;border-bottom:1px solid rgba(11,18,38,0.06);font-size:14px}
th{background:transparent;text-align:left;color:var(--muted);font-weight:600}
.series-input{width:68px;padding:6px;border-radius:8px;border:1px solid rgba(11,18,38,0.06);text-align:center}
.checkbox{transform:scale(1.05);margin-right:6px}
.section-title{font-weight:600;margin-bottom:6px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.note{font-size:13px;color:var(--muted);margin-top:8px}
.stats{display:flex;flex-direction:column;gap:8px}
.stat-row{display:flex;justify-content:space-between;background:rgba(11,18,38,0.03);padding:8px;border-radius:8px}
.green{color:var(--success);font-weight:700}
.yellow{color:var(--warn);font-weight:700}
.red{color:var(--error);font-weight:700}
.actions{display:flex;gap:8px;margin-left:8px}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(11,18,38,0.06);padding:8px 10px;border-radius:10px;cursor:pointer}
.btn-small{font-size:11px;padding:4px 8px;border-radius:8px}
.history-list{max-height:300px;overflow:auto;margin-top:8px;display:flex;flex-direction:column;gap:8px}
.history-item{padding:8px;border-radius:8px;background:rgba(11,18,38,0.02);display:flex;justify-content:space-between;align-items:center}
.flex-col{display:flex;flex-direction:column;gap:6px}
.footer{margin-top:10px;font-size:12px;color:var(--muted)}
.canvas-wrap{background:var(--card);border-radius:10px;padding:8px;}
@media (max-width:980px){.container{grid-template-columns:1fr;}}
.progress-bar{height:10px;border-radius:5px;background:rgba(11,18,38,0.1);margin-top:4px;overflow:hidden}
.progress-fill{height:10px;background:var(--accent);width:0%;}
.timer{font-weight:700;font-size:16px;margin-top:6px;text-align:center}
.set-row-done{background:rgba(16,185,129,0.08);}
.set-row-partial{background:rgba(245,158,11,0.08);}
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:999px;font-size:11px}
.badge-dot{width:8px;height:8px;border-radius:999px;background:var(--accent);}
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:6px;font-size:11px}
.week-day{padding:6px;border-radius:8px;background:rgba(11,18,38,0.02);min-height:60px}
.week-day strong{font-size:11px;display:block;margin-bottom:2px}
.week-day span{display:block}
.tag{display:inline-block;padding:2px 6px;border-radius:999px;font-size:10px;background:rgba(11,18,38,0.04);margin-top:2px}
.kcal{font-weight:600}
.history-buttons{display:flex;gap:6px;align-items:center}

/* MOBILE – iPhone / PWA */
@media (max-width:768px){

  body{
    margin:6px;
    font-size:14px;
    padding-bottom:60px; /* miejsce na dolny pasek */
  }

  header{
    position:sticky;
    top:0;
    z-index:40;
    padding:6px 4px;
    background:var(--bg);
    flex-direction:column;
    align-items:flex-start;
    gap:6px;
  }

  h1{
    font-size:15px;
  }

  .small{
    font-size:11px;
  }

  .section-title{
    font-size:14px;
  }

  th,td{
    font-size:13px;
  }

  .workout-title{
    flex-direction:column;
    align-items:flex-start;
    gap:4px;
  }

  /* GÓRNE KONTROLKI – jedna pod drugą */
  .controls{
    width:100%;
    gap:6px;
    align-items:stretch;
  }
  .controls > *{
    flex:1 1 100%;
  }
  #sessionDate,#sessionType,#bodyWeight{
    width:100% !important;
  }

  .actions{
    margin-left:0;
    width:100%;
    gap:6px;
  }
  .actions button{
    flex:1 1 50%;
  }

  .input,
  select,
  button{
    padding:8px 10px;
    font-size:14px;
  }

  .btn-primary,
  .btn-ghost{
    min-height:38px;
  }

  .card{
    padding:6px 6px;
    border-radius:12px;
  }

  th, td{
    padding:4px;
  }

  .note{
    font-size:11px;
  }

  .row{
    width:100%;
  }

  .row > input,
  .row > select,
  .row > button{
    flex:1 1 calc(50% - 6px);
    width:100% !important;
  }

  .series-input{
    width:70px;
    padding:6px;
    font-size:14px;
  }

  .checkbox{
    transform:scale(1.2);
    margin-right:6px;
  }

  .history-list{
    max-height:220px;
  }

  /* SEKCJA ĆWICZEŃ – mobilny układ */
  .exercise-table{
    width:100%;
  }
  .exercise-table thead{
    display:none;
  }
  .exercise-table tr{
    display:grid;
    grid-template-columns:1fr 1fr;
    grid-template-rows:auto auto;
    gap:4px;
    padding:4px 0;
  }
  .exercise-table td{
    border:none;
    padding:2px 4px;
  }
  .exercise-table td[data-label="Seria"]{
    grid-column:1/2;
    grid-row:1;
    font-weight:600;
  }
  .exercise-table td[data-label="Ciężar"]{
    grid-column:2/3;
    grid-row:1;
  }
  .exercise-table td[data-label="Powt."]{
    grid-column:1/2;
    grid-row:2;
  }
  .exercise-table td[data-label="Odhacz"]{
    grid-column:2/3;
    grid-row:2;
    display:flex;
    justify-content:flex-end;
    align-items:center;
  }

  #planEditorCard,
  aside .card{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  #planEditorArea table{
    min-width:480px;
  }

  /* KALENDARZ – poziomy scroll */
  .week-grid{
    display:grid;
    grid-auto-flow:column;
    grid-auto-columns:minmax(110px, 1fr);
    gap:6px;
    margin-top:6px;
    font-size:11px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  .week-day{
    min-height:auto;
    padding:6px;
    white-space:normal;
  }

  /* Wykresy – trochę niższe */
  #chartVolume,
  #chartWeight{
    height:140px !important;
  }

  .container{
    grid-template-columns:1fr;
    gap:8px;
  }

  /* --- Sekcje mobilne + dolny pasek --- */
  .mobile-section{
    display:none;
  }
  .mobile-section.active{
    display:block;
  }

  .mobile-nav{
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    height:52px;
    background:var(--card);
    border-top:1px solid rgba(11,18,38,0.08);
    display:flex;
    z-index:50;
  }
  .mobile-nav-btn{
    flex:1;
    border:none;
    background:transparent;
    font-size:12px;
    font-weight:500;
    padding:6px 4px;
    cursor:pointer;
    color:var(--muted);
  }
  .mobile-nav-btn.active{
    color:var(--accent);
    border-top:2px solid var(--accent);
  }
}
</style>
</head>
<body data-theme="light">
<header>
  <div>
    <h1>Trening Tracker – Premium 4.3</h1>
    <div class="small">Styl C – jasny/ciemny | Progresja, kalendarz, statystyki, Apple Watch, własne plany</div>
  </div>
  <div class="controls">
    <input type="date" id="sessionDate" class="input">
    <select id="sessionType" class="input"></select>
    <input id="bodyWeight" class="input" placeholder="Waga kg" type="number" step="0.1" style="width:95px">
    <div class="actions">
      <button id="themeToggle" class="btn-ghost">Dark</button>
      <button id="saveBtn" class="btn-primary">Zapisz sesję</button>
    </div>
  </div>
</header>

<div class="container">
  <div>
    <!-- SEKCJA TRENINGU -->
    <div class="card mobile-section" id="workoutCard" data-section="workout">
      <div class="workout-title">
        <div class="flex-col">
          <div class="section-title" id="planTitle">Trening A</div>
          <div class="small" id="planSubtitle">10 min rower | rozgrzewka</div>
        </div>
        <div class="small">Kolorowe serie, automatyczna progresja</div>
      </div>

      <div class="card" style="margin-top:0;">
        <div class="section-title">Dane z Apple Watch</div>
        <div class="row">
          <input id="sessionKcal" class="input" type="number" placeholder="Kcal (Apple Watch)" style="width:130px">
          <input id="avgHr" class="input" type="number" placeholder="Średnie tętno" style="width:120px">
          <input id="maxHr" class="input" type="number" placeholder="Maks. tętno" style="width:120px">
          <input id="durationMin" class="input" type="number" placeholder="Czas (min)" style="width:100px">
        </div>
        <div class="small note">Jeśli podasz kcal z Apple Watch, będą użyte w statystykach (autoliczenie jest tylko zapasowe).</div>
      </div>

      <div id="workoutArea" style="margin-top:10px;"></div>

      <div class="card" style="margin-top:10px">
        <div class="section-title">Timer / Interwał (sekundy)</div>
        <div class="row">
          <input type="number" id="restTime" class="input" placeholder="Przerwa 60" style="width:100px">
          <button id="startTimer" class="btn-primary">Start</button>
          <button id="stopTimer" class="btn-ghost">Stop</button>
          <div class="timer" id="timerDisplay">0s</div>
        </div>
        <div class="small note">Po skończeniu odliczania usłyszysz sygnał dźwiękowy.</div>
      </div>

      <div class="card" style="margin-top:10px" id="planEditorCard">
        <div class="section-title">Edytor planów / własne treningi</div>
        <div class="small">Zmień ćwiczenia, serie, powtórzenia lub dodaj nowy plan. Domyślne A/B/C są bazą – możesz je modyfikować.</div>
        <div class="row" style="margin-top:6px">
          <select id="planSelect" class="input"></select>
          <button id="newPlanBtn" class="btn-ghost btn-small">Nowy plan</button>
        </div>
        <div id="planEditorArea" class="small" style="margin-top:8px"></div>
        <button id="addExerciseBtn" class="btn-ghost btn-small" style="margin-top:6px">Dodaj ćwiczenie</button>
        <button id="savePlanBtn" class="btn-primary" style="margin-top:8px;width:100%">Zapisz plan</button>
      </div>
    </div>
  </div>

  <aside>
    <!-- KALENDARZ -->
    <div class="card mobile-section" id="calendarCard" data-section="calendar">
      <div class="section-title">Kalendarz / podsumowanie tygodnia</div>
      <div id="calendarWeek" class="small">Ładowanie...</div>
      <div style="margin-top:10px;">
        <div class="section-title">Zaawansowane statystyki</div>
        <div id="statsWeek" class="small">Ładowanie...</div>
      </div>
    </div>

    <!-- HISTORIA -->
    <div class="card mobile-section" id="historyCard" data-section="history" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="section-title">Historia sesji</div>
        <button id="loadLastBtn" class="btn-ghost btn-small">Otwórz ostatnią</button>
      </div>
      <div id="history" class="history-list"><div class="small">Brak zapisanych sesji.</div></div>
      <div class="footer small">Dane zapisane lokalnie (localStorage). Możesz w każdej chwili zrobić backup przez skopiowanie danych z konsoli.</div>
    </div>

    <!-- WYKRESY -->
    <div class="card mobile-section" id="chartsCard" data-section="charts" style="margin-top:12px">
      <div class="section-title">Progres / wykresy</div>
      <div class="canvas-wrap"><canvas id="chartVolume" style="width:100%;height:180px"></canvas></div>
      <div class="canvas-wrap" style="margin-top:10px"><canvas id="chartWeight" style="width:100%;height:180px"></canvas></div>
    </div>
  </aside>
</div>

<nav class="mobile-nav">
  <button class="mobile-nav-btn active" data-section="workout">Trening</button>
  <button class="mobile-nav-btn" data-section="calendar">Tydzień</button>
  <button class="mobile-nav-btn" data-section="history">Historia</button>
  <button class="mobile-nav-btn" data-section="charts">Wykresy</button>
</nav>

<audio id="alarmAudio" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
  Twoja przeglądarka nie obsługuje audio.
</audio>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- Klucze storage ---
const STORAGE_KEYS = {
  PLANS: 'tt_plans_v4',
  SESSIONS: 'tt_sessions_v4',
  SETTINGS: 'tt_settings_v4'
};

// --- Domyślne plany ---
const defaultPlans = {
  A: {
    id: 'A',
    label: 'Trening A',
    warmup: '10 min rower - rozgrzewka',
    exercises: [
      {name:"Wyciskanie na ławce płaskiej", sets:4, r
