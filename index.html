<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Trening Tracker Premium 4.3</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
  --bg:#f6f7fb; --card:#fff; --text:#0b1226; --muted:#6b7280; --accent:#2b8aef;
  --accent-2:#7dd3fc; --success:#10b981; --warn:#f59e0b; --error:#ef4444;
}
[data-theme="dark"]{
  --bg:#071022; --card:#071827; --text:#e6eef8; --muted:#9aa9bc; --accent:#4fb3ff;
  --accent-2:#2b8aef; --success:#34d399; --warn:#fbbf24; --error:#f87171;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
html,body{
  max-width:100%;
  overflow-x:hidden;
}
body{
  margin:12px;
  padding-top:env(safe-area-inset-top);
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
h1{font-size:18px;margin:0;font-weight:600}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.input, select, button, textarea{padding:8px;border-radius:10px;border:1px solid rgba(11,18,38,0.06);background:var(--card);color:var(--text)}
textarea{resize:none}
.small{font-size:12px;color:var(--muted)}
.container{display:grid;grid-template-columns:1fr 420px;gap:12px;align-items:start}
.card{background:var(--card);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);}
.workout-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
table{width:100%;border-collapse:collapse}
th,td{padding:6px;border-bottom:1px solid rgba(11,18,38,0.06);font-size:14px}
th{background:transparent;text-align:left;color:var(--muted);font-weight:600}
.series-input{width:68px;padding:6px;border-radius:8px;border:1px solid rgba(11,18,38,0.06);text-align:center}
.checkbox{transform:scale(1.05);margin-right:6px}
.section-title{font-weight:600;margin-bottom:6px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.note{font-size:13px;color:var(--muted);margin-top:8px}
.stats{display:flex;flex-direction:column;gap:8px}
.stat-row{display:flex;justify-content:space-between;background:rgba(11,18,38,0.03);padding:8px;border-radius:8px}
.green{color:var(--success);font-weight:700}
.yellow{color:var(--warn);font-weight:700}
.red{color:var(--error);font-weight:700}
.actions{display:flex;gap:8px;margin-left:8px}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(11,18,38,0.06);padding:8px 10px;border-radius:10px;cursor:pointer}
.btn-small{font-size:11px;padding:4px 8px;border-radius:8px}
.history-list{max-height:300px;overflow:auto;margin-top:8px;display:flex;flex-direction:column;gap:8px}
.history-item{padding:8px;border-radius:8px;background:rgba(11,18,38,0.02);display:flex;justify-content:space-between;align-items:center}
.flex-col{display:flex;flex-direction:column;gap:6px}
.footer{margin-top:10px;font-size:12px;color:var(--muted)}
.canvas-wrap{background:var(--card);border-radius:10px;padding:8px;}
@media (max-width:980px){.container{grid-template-columns:1fr;}}
.progress-bar{height:10px;border-radius:5px;background:rgba(11,18,38,0.1);margin-top:4px;overflow:hidden}
.progress-fill{height:10px;background:var(--accent);width:0%;}
.timer{font-weight:700;font-size:16px;margin-top:6px;text-align:center}
.set-row-done{background:rgba(16,185,129,0.08);}
.set-row-partial{background:rgba(245,158,11,0.08);}
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:999px;font-size:11px}
.badge-dot{width:8px;height:8px;border-radius:999px;background:var(--accent);}
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:6px;font-size:11px}
.week-day{padding:6px;border-radius:8px;background:rgba(11,18,38,0.02);min-height:60px}
.week-day strong{font-size:11px;display:block;margin-bottom:2px}
.week-day span{display:block}
.tag{display:inline-block;padding:2px 6px;border-radius:999px;font-size:10px;background:rgba(11,18,38,0.04);margin-top:2px}
.kcal{font-weight:600}
.history-buttons{display:flex;gap:6px;align-items:center}

/* MOBILE ‚Äì iPhone / PWA */
@media (max-width:768px){

  body{
    margin:6px;
    font-size:14px;
    padding-bottom:60px; /* miejsce na dolny pasek */
  }

  header{
    position:sticky;
    top:0;
    z-index:40;
    padding:6px 4px;
    background:var(--bg);
    flex-direction:column;
    align-items:flex-start;
    gap:6px;
  }

  h1{
    font-size:15px;
  }

  .small{
    font-size:11px;
  }

  .section-title{
    font-size:14px;
  }

  th,td{
    font-size:13px;
  }

  .workout-title{
    flex-direction:column;
    align-items:flex-start;
    gap:4px;
  }

  .controls{
    width:100%;
    gap:6px;
    align-items:stretch;
  }
  .controls > *{
    flex:1 1 100%;
  }
  #sessionDate,#sessionType,#bodyWeight{
    width:100% !important;
  }

  .actions{
    margin-left:0;
    width:100%;
    gap:6px;
  }
  .actions button{
    flex:1 1 50%;
  }

  .input,
  select,
  button{
    padding:8px 10px;
    font-size:14px;
  }

  .btn-primary,
  .btn-ghost{
    min-height:38px;
  }

  .card{
    padding:6px 6px;
    border-radius:12px;
  }

  th, td{
    padding:4px;
  }

  .note{
    font-size:11px;
  }

  .row{
    width:100%;
  }

  .row > input,
  .row > select,
  .row > button{
    flex:1 1 calc(50% - 6px);
    width:100% !important;
  }

  .series-input{
    width:70px;
    padding:6px;
    font-size:14px;
  }

  .checkbox{
    transform:scale(1.2);
    margin-right:6px;
  }

  .history-list{
    max-height:220px;
  }

  /* ƒÜwiczenia ‚Äì poziom: S1 | ciƒô≈ºar | powt. | checkbox */
.exercise-table{
  width:100%;
  border-collapse:collapse;
}
.exercise-table thead{
  display:none; /* bez nag≈Ç√≥wka na mobile */
}
.exercise-table tr{
  display:flex;
  align-items:center;
  gap:6px;
  padding:4px 0;
}
.exercise-table td{
  border:none;
  padding:0 2px;
}

/* S1 / S2 / S3 ‚Äì wƒÖska kolumna */
.exercise-table td[data-label="Seria"]{
  width:32px;
  font-weight:600;
}

/* Ciƒô≈ºar i powt√≥rzenia dzielƒÖ miejsce po ≈õrodku */
.exercise-table td[data-label="Ciƒô≈ºar"],
.exercise-table td[data-label="Powt."]{
  flex:1;
}

/* Checkbox po prawej stronie */
.exercise-table td[data-label="Odhacz"]{
  width:32px;
  display:flex;
  justify-content:flex-end;
  align-items:center;
}

/* Ma≈Çe etykiety nad polami (opcjonalnie) */
.exercise-table td[data-label="Ciƒô≈ºar"]::before,
.exercise-table td[data-label="Powt."]::before{
  display:block;
  font-size:10px;
  color:var(--muted);
  margin-bottom:2px;
}
.exercise-table td[data-label="Ciƒô≈ºar"]::before{ content:"Ciƒô≈ºar (kg)"; }
.exercise-table td[data-label="Powt."]::before{ content:"Powt."; }


  /* --- EDYTOR PLAN√ìW ‚Äì kompaktowy uk≈Çad 2 linie --- */
  #planEditorArea table{
    width:100%;
    border-collapse:separate;
    border-spacing:0 6px; /* odstƒôp miƒôdzy ƒáwiczeniami */
  }
  #planEditorArea thead{
    display:none; /* chowamy nag≈Ç√≥wek tabeli */
  }
  #planEditorArea tr{
    display:grid;
    grid-template-columns:2fr 1fr 1fr auto; /* name | sets | muscle | X */
    grid-template-rows:auto auto;          /* (ƒáwiczenie/serie) + (powt/partia) */
    grid-template-areas:
      "name sets sets remove"
      "reps reps muscle remove";
    gap:4px 6px;
    padding:4px 0;
    align-items:center;
  }
  #planEditorArea td{
    border:none;
    padding:0;
  }
  #planEditorArea td:nth-child(1){ /* ƒáwiczenie */
    grid-area:name;
  }
  #planEditorArea td:nth-child(2){ /* serie */
    grid-area:sets;
  }
  #planEditorArea td:nth-child(3){ /* powt√≥rzenia */
    grid-area:reps;
  }
  #planEditorArea td:nth-child(4){ /* partia */
    grid-area:muscle;
  }
  #planEditorArea td:nth-child(5){ /* X */
    grid-area:remove;
    justify-self:end;
  }
  /* etykiety nad polami ‚Äì jak ‚ÄûƒÜwiczenie  Serie / Powt  Partia‚Äù */
  #planEditorArea td:nth-child(1)::before,
  #planEditorArea td:nth-child(2)::before,
  #planEditorArea td:nth-child(3)::before,
  #planEditorArea td:nth-child(4)::before{
    display:block;
    font-size:10px;
    color:var(--muted);
    margin-bottom:2px;
  }
  #planEditorArea td:nth-child(1)::before{content:"ƒÜwiczenie";}
  #planEditorArea td:nth-child(2)::before{content:"Serie";}
  #planEditorArea td:nth-child(3)::before{content:"Powt.";}
  #planEditorArea td:nth-child(4)::before{content:"Partia";}

  #planEditorArea input.input{
    width:100%;
    font-size:13px;
    padding:6px 8px;
  }

  #planEditorCard{
    overflow:visible;
  }

   /* KALENDARZ ‚Äì mobile: 4 dni w pierwszym rzƒôdzie, 3 w drugim, bez poziomego scrolla */
  .week-grid{
    display:grid;
    grid-template-columns:repeat(4, minmax(0, 1fr)); /* Pn‚ÄìCz w pierwszym rzƒôdzie, Pt‚ÄìNd w drugim */
    gap:6px;
    margin-top:6px;
    font-size:11px;
  }

  .week-day{
    min-height:auto;
    padding:6px;
    white-space:normal;
    background:rgba(11,18,38,0.02);
    border-radius:8px;
  }



  #chartVolume,
  #chartWeight{
    height:140px !important;
  }

  .container{
    grid-template-columns:1fr;
    gap:8px;
  }

  /* --- sekcje mobilne + bottom nav --- */
  .mobile-section{
    display:none;
  }
  .mobile-section.active{
    display:block;
  }

  .mobile-nav{
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    height:52px;
    background:var(--card);
    border-top:1px solid rgba(11,18,38,0.08);
    display:flex;
    z-index:50;
  }
  .mobile-nav-btn{
    flex:1;
    border:none;
    background:transparent;
    font-size:12px;
    font-weight:500;
    padding:6px 4px;
    cursor:pointer;
    color:var(--muted);
  }
  .mobile-nav-btn.active{
    color:var(--accent);
    border-top:2px solid var(--accent);
  }
}
</style>
</head>
<body data-theme="light">
<header>
  <div>
    <h1>Trening Tracker ‚Äì Premium 4.3</h1>
    <div class="small">Styl C ‚Äì jasny/ciemny | Progresja, kalendarz, statystyki, Apple Watch, w≈Çasne plany</div>
  </div>
  <div class="controls">
    <input type="date" id="sessionDate" class="input">
    <select id="sessionType" class="input"></select>
    <input id="bodyWeight" class="input" placeholder="Waga kg" type="number" step="0.1" style="width:95px">
    <div class="actions">
      <button id="themeToggle" class="btn-ghost">Dark</button>
      <button id="saveBtn" class="btn-primary">Zapisz sesjƒô</button>
    </div>
  </div>
</header>

<div class="container">
  <div>
    <!-- G≈Å√ìWNY TRENING -->
    <div class="card mobile-section" id="workoutCard" data-section="workout">
      <div class="workout-title">
        <div class="flex-col">
          <div class="section-title" id="planTitle">Trening A</div>
          <div class="small" id="planSubtitle">10 min rower | rozgrzewka</div>
        </div>
        <div class="small">Kolorowe serie, automatyczna progresja</div>
      </div>

      <div class="card" style="margin-top:0;">
        <div class="section-title">Dane z Apple Watch</div>
        <div class="row">
          <input id="sessionKcal" class="input" type="number" placeholder="Kcal (Apple Watch)" style="width:130px">
          <input id="avgHr" class="input" type="number" placeholder="≈örednie tƒôtno" style="width:120px">
          <input id="maxHr" class="input" type="number" placeholder="Maks. tƒôtno" style="width:120px">
          <input id="durationMin" class="input" type="number" placeholder="Czas (min)" style="width:100px">
        </div>
        <div class="small note">Je≈õli podasz kcal z Apple Watch, bƒôdƒÖ u≈ºyte w statystykach (autoliczenie jest tylko zapasowe).</div>
      </div>

      <div id="workoutArea" style="margin-top:10px;"></div>

      <div class="card" style="margin-top:10px">
        <div class="section-title">Timer / Interwa≈Ç (sekundy)</div>
        <div class="row">
          <input type="number" id="restTime" class="input" placeholder="Przerwa 60" style="width:100px">
          <button id="startTimer" class="btn-primary">Start</button>
          <button id="stopTimer" class="btn-ghost">Stop</button>
          <div class="timer" id="timerDisplay">0s</div>
        </div>
        <div class="small note">Po sko≈Ñczeniu odliczania us≈Çyszysz sygna≈Ç d≈∫wiƒôkowy.</div>
      </div>

      <div class="card" style="margin-top:10px" id="planEditorCard">
        <div class="section-title">Edytor plan√≥w / w≈Çasne treningi</div>
        <div class="small">Zmie≈Ñ ƒáwiczenia, serie, powt√≥rzenia lub dodaj nowy plan. Domy≈õlne A/B/C sƒÖ bazƒÖ ‚Äì mo≈ºesz je modyfikowaƒá.</div>
        <div class="row" style="margin-top:6px">
          <select id="planSelect" class="input"></select>
          <button id="newPlanBtn" class="btn-ghost btn-small">Nowy plan</button>
        </div>
        <div id="planEditorArea" class="small" style="margin-top:8px"></div>
        <button id="addExerciseBtn" class="btn-ghost btn-small" style="margin-top:6px">Dodaj ƒáwiczenie</button>
        <button id="savePlanBtn" class="btn-primary" style="margin-top:8px;width:100%">Zapisz plan</button>
      </div>
    </div>
  </div>

  <aside>
    <!-- KALENDARZ / STATY -->
    <div class="card mobile-section" data-section="calendar">
      <div class="section-title">Kalendarz / podsumowanie tygodnia</div>
      <div id="calendarWeek" class="small">≈Åadowanie...</div>
      <div style="margin-top:10px;">
        <div class="section-title">Zaawansowane statystyki</div>
        <div id="statsWeek" class="small">≈Åadowanie...</div>
      </div>
    </div>

    <!-- HISTORIA SESJI -->
   <div class="card mobile-section" data-section="history" style="margin-top:12px">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div class="section-title">Historia sesji</div>
    <div class="history-buttons">
      <button id="loadLastBtn" class="btn-ghost btn-small">Otw√≥rz ostatniƒÖ</button>
      <button id="exportBtn" class="btn-ghost btn-small">Eksport JSON</button>
      <button id="importBtn" class="btn-primary btn-small">Import JSON</button>
    </div>
  </div>
  <div id="history" class="history-list"><div class="small">Brak zapisanych sesji.</div></div>
  <div class="footer small">Dane zapisane lokalnie (localStorage). Mo≈ºesz w ka≈ºdej chwili zrobiƒá backup przez eksport JSON.</div>
</div>


    <!-- WYKRESY -->
    <div class="card mobile-section" data-section="charts" style="margin-top:12px">
      <div class="section-title">Progres / wykresy</div>
      <div class="canvas-wrap"><canvas id="chartVolume" style="width:100%;height:180px"></canvas></div>
      <div class="canvas-wrap" style="margin-top:10px"><canvas id="chartWeight" style="width:100%;height:180px"></canvas></div>
    </div>
  </aside>
</div>

<!-- DOLNE ZAK≈ÅADKI -->
<nav class="mobile-nav">
  <button class="mobile-nav-btn active" data-section="workout">Trening</button>
  <button class="mobile-nav-btn" data-section="calendar">Tydzie≈Ñ</button>
  <button class="mobile-nav-btn" data-section="history">Historia</button>
  <button class="mobile-nav-btn" data-section="charts">Wykresy</button>
</nav>

<audio id="alarmAudio" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
  Twoja przeglƒÖdarka nie obs≈Çuguje audio.
</audio>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- Klucze storage ---
const STORAGE_KEYS = {
  PLANS: 'tt_plans_v4',
  SESSIONS: 'tt_sessions_v4',
  SETTINGS: 'tt_settings_v4',
  EXERCISES: 'tt_exercises_v1'
};

// --- Domy≈õlne plany ---
const defaultPlans = {
  A: {
    id: 'A',
    label: 'Trening A',
    warmup: '10 min rower - rozgrzewka',
    exercises: [
      {name:"Wyciskanie na ≈Çawce p≈Çaskiej", sets:4, reps:"6-10", muscle:"klatka"},
      {name:"Wios≈Çowanie w opadzie", sets:4, reps:"8-12", muscle:"plecy"},
      {name:"Hip thrust", sets:4, reps:"8-12", muscle:"po≈õladki"},
      {name:"Prostowanie n√≥g", sets:3, reps:"12-15", muscle:"czworog≈Çowe"},
      {name:"Uginanie n√≥g", sets:3, reps:"12-15", muscle:"dwug≈Çowe"}
    ]
  },
  B: {
    id: 'B',
    label: 'Trening B',
    warmup: '10 min rower - rozgrzewka',
    exercises: [
      {name:"≈öciƒÖganie drƒÖ≈ºka do klatki", sets:4, reps:"8-12", muscle:"plecy"},
      {name:"Wyciskanie nad g≈Çowƒô hantlami", sets:3, reps:"6-10", muscle:"barki"},
      {name:"Step-up niski", sets:3, reps:"8-10/str", muscle:"nogi"},
      {name:"Martwy ciƒÖg rumu≈Ñski", sets:3, reps:"8-12", muscle:"dwug≈Çowe"}
    ]
  },
  C: {
    id: 'C',
    label: 'Trening C',
    warmup: '10 min rower - rozgrzewka',
    exercises: [
      {name:"Wyciskanie hantli na skosie", sets:4, reps:"8-12", muscle:"klatka"},
      {name:"Rozpiƒôtki lub guma fly", sets:3, reps:"12-15", muscle:"klatka"},
      {name:"Wios≈Çowanie dolnym wyciƒÖgiem", sets:3, reps:"10-12", muscle:"plecy"},
      {name:"Hip thrust", sets:4, reps:"8-12", muscle:"po≈õladki"}
    ]
  }
};
// --- Domy≈õlna baza ƒáwicze≈Ñ ---
const defaultExercises = [
  { id:"bench_flat",      name:"Wyciskanie na ≈Çawce p≈Çaskiej", muscle:"klatka" },
  { id:"row_bb",          name:"Wios≈Çowanie w opadzie", muscle:"plecy" },
  { id:"hip_thrust",      name:"Hip thrust", muscle:"po≈õladki" },
  { id:"leg_ext",         name:"Prostowanie n√≥g", muscle:"czworog≈Çowe" },
  { id:"leg_curl",        name:"Uginanie n√≥g", muscle:"dwug≈Çowe" },
  { id:"lat_pulldown",    name:"≈öciƒÖganie drƒÖ≈ºka do klatki", muscle:"plecy" },
  { id:"ohp_db",          name:"Wyciskanie nad g≈Çowƒô hantlami", muscle:"barki" },
  { id:"step_up",         name:"Step-up", muscle:"nogi" },
  { id:"rdl",             name:"Martwy ciƒÖg rumu≈Ñski", muscle:"dwug≈Çowe" },
  { id:"incline_db",      name:"Wyciskanie hantli na skosie", muscle:"klatka" },
  { id:"fly",             name:"Rozpiƒôtki / guma fly", muscle:"klatka" },
  { id:"row_low",         name:"Wios≈Çowanie dolnym wyciƒÖgiem", muscle:"plecy" }
];

// --- Pomocnicze DOM ---
function el(q){ return document.querySelector(q) }
function elAll(q){ return Array.from(document.querySelectorAll(q)) }

const workoutArea = el('#workoutArea');
const sessionType = el('#sessionType');
const sessionDate = el('#sessionDate');
const saveBtn = el('#saveBtn');
const historyDiv = el('#history');
const planTitle = el('#planTitle');
const planSubtitle = el('#planSubtitle');
const themeToggle = el('#themeToggle');
const timerDisplay = el('#timerDisplay');
const planSelect = el('#planSelect');
const planEditorArea = el('#planEditorArea');
const calendarWeekDiv = el('#calendarWeek');
const statsWeekDiv = el('#statsWeek');
const loadLastBtn = el('#loadLastBtn');
const exportBtn = el('#exportBtn');
const importBtn = el('#importBtn');  
const alarmAudio = document.getElementById('alarmAudio');

let timerInterval = null;
let timerSec = 0;
let plans = {};
let sessions = [];
let chartVolume = null;
let chartWeight = null;

// --- Storage helpers ---
function loadPlans(){
  try{
    const raw = localStorage.getItem(STORAGE_KEYS.PLANS);
    if(!raw) return JSON.parse(JSON.stringify(defaultPlans));
    const parsed = JSON.parse(raw);
    return {...JSON.parse(JSON.stringify(defaultPlans)), ...parsed};
  }catch(e){
    console.warn('B≈ÇƒÖd wczytywania plan√≥w', e);
    return JSON.parse(JSON.stringify(defaultPlans));
  }
}
function savePlans(){
  localStorage.setItem(STORAGE_KEYS.PLANS, JSON.stringify(plans));
}

function loadSessions(){
  try{
    const raw = localStorage.getItem(STORAGE_KEYS.SESSIONS);
    if(!raw) return [];
    return JSON.parse(raw);
  }catch(e){
    console.warn('B≈ÇƒÖd wczytywania sesji', e);
    return [];
  }
}
function saveSessions(){
  localStorage.setItem(STORAGE_KEYS.SESSIONS, JSON.stringify(sessions));
}
// --- Baza ƒáwicze≈Ñ (localStorage) ---
let exercises = [];

function loadExercises(){
  try{
    const raw = localStorage.getItem(STORAGE_KEYS.EXERCISES);
    if(!raw) return [...defaultExercises];
    return JSON.parse(raw);
  }catch(e){
    console.warn("B≈ÇƒÖd ≈Çadowania bazy ƒáwicze≈Ñ", e);
    return [...defaultExercises];
  }
}

function saveExercises(){
  localStorage.setItem(STORAGE_KEYS.EXERCISES, JSON.stringify(exercises));
}

// --- Theme toggle ---
themeToggle.addEventListener('click', ()=>{
  const current = document.body.getAttribute('data-theme') || 'light';
  const next = current==='light' ? 'dark' : 'light';
  document.body.setAttribute('data-theme', next);
  themeToggle.textContent = next==='dark' ? 'Light' : 'Dark';
});

// --- Inicjalizacja plan√≥w w selectach ---
function refreshPlanSelects(){
  sessionType.innerHTML = '';
  planSelect.innerHTML = '';
  Object.values(plans).forEach(p=>{
    const opt1 = document.createElement('option');
    opt1.value = p.id;
    opt1.textContent = p.label;
    sessionType.appendChild(opt1);

    const opt2 = document.createElement('option');
    opt2.value = p.id;
    opt2.textContent = p.label;
    planSelect.appendChild(opt2);
  });
}

// --- Helpery dat ---
function parseDate(d){
  if(!d) return new Date();
  const parts = d.split('-').map(Number);
  const y = parts[0];
  const m = (parts[1] || 1) - 1;
  const day = parts[2] || 1;
  return new Date(y, m, day);
}
function formatLocalDate(date){
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2,'0');
  const d = String(date.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

// --- Render planu ---
function renderPlan(typeId){
  const plan = plans[typeId];
  if(!plan) return;
  planTitle.textContent = plan.label;
  planSubtitle.textContent = plan.warmup || '10 min rower - rozgrzewka';
  workoutArea.innerHTML = '';
  const exercises = plan.exercises || [];

  exercises.forEach((ex, idx)=>{
    const wrapper=document.createElement('div');
    wrapper.className='card';
    let html=`<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${ex.name}</strong><div class="small">${ex.muscle || ''}</div></div>
      <div class="small">Serii: ${ex.sets} ‚Ä¢ Powt: ${ex.reps}</div>
    </div>`;
        html += '<table class="exercise-table"><thead><tr><th>Seria</th><th>Ciƒô≈ºar (kg)</th><th>Plan</th><th>Powt. wykonane</th><th>Odhacz</th></tr></thead><tbody>';
    for(let s=1; s<=ex.sets; s++){
      html += `<tr class="set-row" data-ex="${idx}" data-set="${s}">
        <td data-label="Seria">S${s}</td>
        <td data-label="Ciƒô≈ºar">
          <input
            type="number"
            class="series-input weight-input"
            data-ex="${idx}"
            data-set="${s}"
            placeholder=""
            step="0.5"
          />
        </td>
        <td data-label="Plan" class="small">${ex.reps}</td>
        <td data-label="Powt.">
          <input
            type="number"
            class="series-input reps-input"
            data-ex="${idx}"
            data-set="${s}"
            placeholder=""
          />
        </td>
        <td data-label="Odhacz">
          <input type="checkbox" class="checkbox" data-ex="${idx}" data-set="${s}"/>
        </td>
      </tr>`;
    }
    html += '</tbody></table>';
    html+='<div class="progress-bar"><div class="progress-fill" id="progress-'+idx+'"></div></div>';
    wrapper.innerHTML=html;
    workoutArea.appendChild(wrapper);
  });

  attachSeriesEvents();
  applyLastSessionProgression(typeId);
}

// --- Kolorowanie serii i progress bar ---
function attachSeriesEvents(){
  elAll('.checkbox').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      updateProgress();
      updateSetRowStyle(cb);
    });
  });
}
function updateSetRowStyle(cb){
  const row = cb.closest('.set-row');
  if(!row) return;
  if(cb.checked){
    row.classList.add('set-row-done');
    row.classList.remove('set-row-partial');
  }else{
    row.classList.remove('set-row-done');
  }
}
  function getPlannedRepsNumber(repsStr){
  if(!repsStr) return 0;
  const rangeMatch = repsStr.match(/(\d+)\s*-\s*(\d+)/);
  if(rangeMatch){
    return parseInt(rangeMatch[2]); // bierzemy g√≥rny zakres, np. 6-10 -> 10
  }
  const singleMatch = repsStr.match(/(\d+)/);
  return singleMatch ? parseInt(singleMatch[1]) : 0;
}

function updateProgress(){
  const plan = plans[sessionType.value];
  if(!plan) return;
  (plan.exercises || []).forEach((ex, idx)=>{
    const boxes = elAll(`input.checkbox[data-ex="${idx}"]`);
    let done=boxes.filter(x=>x.checked).length;
    let total=boxes.length;
    let pct = total ? Math.round((done/total)*100) : 0;
    const fill = el('#progress-'+idx);
    if(fill){
      fill.style.width=pct+'%';
      if(done===total && total>0){
        fill.style.backgroundColor='var(--success)';
      }else if(done>0){
        fill.style.backgroundColor='var(--warn)';
      }else{
        fill.style.backgroundColor='var(--error)';
      }
    }
  });
}

// --- Automatyczna progresja ---
function applyLastSessionProgression(planId){
  const plan = plans[planId];
  if(!plan) return;

  const currentDate = sessionDate.value || formatLocalDate(new Date());
  const relevant = sessions
    .filter(s => s.planId === planId && s.date <= currentDate)
    .sort((a,b) => parseDate(b.date) - parseDate(a.date));

  if(!relevant.length) return;

  const lastSession = relevant[0]; // do wziƒôcia bazowego ciƒô≈ºaru

  (plan.exercises || []).forEach((exPlan, idx) => {
    // bierzemy tylko sesje, gdzie pod tym indeksem jest to samo ƒáwiczenie
    const exSessions = relevant.filter(s => {
      const exS = (s.exercises || [])[idx];
      return exS && exS.name === exPlan.name;
    });

    const N = 4; // ilo≈õƒá trening√≥w z rzƒôdu wymaganych do progresji
    if(exSessions.length < N) return;

    const repsGoal = getPlannedRepsNumber(exPlan.reps);

    let allGood = true;

    // sprawdzamy ostatnie N trening√≥w tego ƒáwiczenia
    for(let i=0; i<N; i++){
      const exS = exSessions[i].exercises[idx];
      const setsArr = exS.sets || [];

      const thisSessionGood = setsArr.every(st => {
        const repsDone = typeof st.repsDone === 'number' ? st.repsDone : 0;
        // warunek: seria odhaczona, waga > 0 i powt. wykonane >= zaplanowane
        return st.done && st.weight > 0 && repsDone >= (st.repsPlanned || repsGoal);
      });

      if(!thisSessionGood){
        allGood = false;
        break;
      }
    }

    const step = allGood ? 2.5 : 0;
    if(step === 0) return;

    // korzystamy z ostatniej sesji jako bazowego ciƒô≈ºaru
    const exLast = lastSession.exercises[idx];
    if(!exLast) return;

    (exLast.sets || []).forEach((setLast, sIdx) => {
      const input = el(`input.weight-input[data-ex="${idx}"][data-set="${sIdx+1}"]`);
      if(!input) return;
      const base = parseFloat(setLast.weight) || 0;
      const next = base + step;
      if(next > 0) input.value = next.toFixed(1);
    });
  });
}


// --- Timer ---
el('#startTimer').addEventListener('click', ()=>{
  const val = parseInt(el('#restTime').value) || 60;
  timerSec = val;
  timerDisplay.textContent = timerSec + 's';
  clearInterval(timerInterval);

  if (alarmAudio) {
    alarmAudio.play()
      .then(()=>{
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
      })
      .catch(()=>{});
  }

  timerInterval = setInterval(()=>{
    timerSec--;
    if (timerSec <= 0) {
      clearInterval(timerInterval);
      timerDisplay.textContent = 'KONIEC!';

      if (alarmAudio) {
        alarmAudio.currentTime = 0;
        alarmAudio.play().catch(()=>{});
      }

      const originalTitle = document.title;
      let flashes = 0;
      const flashInt = setInterval(()=>{
        document.title = (document.title === 'ODPOCZYNEK!') ? originalTitle : 'ODPOCZYNEK!';
        flashes++;
        if (flashes > 6){
          clearInterval(flashInt);
          document.title = originalTitle;
        }
      }, 500);
      return;
    }
    timerDisplay.textContent = timerSec + 's';
  }, 1000);
});

el('#stopTimer').addEventListener('click', ()=>{
  clearInterval(timerInterval);
  timerDisplay.textContent='0s';
  if (alarmAudio) {
    alarmAudio.pause();
    alarmAudio.currentTime = 0;
  }
});

// --- Szacowanie kcal ---
function estimateKcal(totalVolume, bodyWeight){
  const bw = bodyWeight || 70;
  const base = totalVolume * 0.08;
  const scaled = base * (bw/70);
  return Math.round(scaled);
}

// --- Zapis sesji ---
function saveSession(){
  const date = sessionDate.value || formatLocalDate(new Date());
  const planId = sessionType.value;
  const plan = plans[planId];
  if(!plan) return alert('Brak planu dla wybranego treningu.');
  const bodyWeight = parseFloat(el('#bodyWeight').value) || null;

  const sessionKcalManual = parseInt(el('#sessionKcal').value) || null;
  const avgHr = parseInt(el('#avgHr').value) || null;
  const maxHr = parseInt(el('#maxHr').value) || null;
  const durationMin = parseInt(el('#durationMin').value) || null;

  const exData = [];
  let totalVolume = 0;
  let totalWeight = 0;
  (plan.exercises || []).forEach((ex, idx)=>{
    const sets = [];
    for(let s=1; s<=ex.sets; s++){
  const wInput  = el(`input.weight-input[data-ex="${idx}"][data-set="${s}"]`);
  const rInput  = el(`input.reps-input[data-ex="${idx}"][data-set="${s}"]`);
  const cb      = el(`input.checkbox[data-ex="${idx}"][data-set="${s}"]`);

  const weight       = wInput ? parseFloat(wInput.value) || 0 : 0;
  const repsPlannedText = ex.reps || '';
  const repsPlanned  = getPlannedRepsNumber(repsPlannedText);
  const repsDone     = rInput ? (parseInt(rInput.value) || 0) : 0;

  // do objƒôto≈õci u≈ºywamy realnie zrobionych powt√≥rze≈Ñ
  totalVolume += weight * repsDone;
  totalWeight += weight;

  sets.push({
    set: s,
    weight,
    repsPlannedText,
    repsPlanned,
    repsDone,
    done: cb ? cb.checked : false
  });
}
    exData.push({
      name: ex.name,
      muscle: ex.muscle || '',
      sets
    });
  });

  const kcalAuto = estimateKcal(totalVolume, bodyWeight);
  const kcalFromWatch = sessionKcalManual;
  const kcal = kcalFromWatch || kcalAuto;

  const session = {
    id: Date.now(),
    date,
    planId,
    planLabel: plan.label,
    bodyWeight,
    exercises: exData,
    totalVolume,
    totalWeight,
    kcal,
    kcalAuto,
    kcalFromWatch,
    avgHr,
    maxHr,
    durationMin
  };
  sessions.push(session);
  sessions.sort((a,b)=> parseDate(a.date) - parseDate(b.date));
  saveSessions();
  renderHistory();
  renderCalendarAndStats();
  updateCharts();
  resetAfterSave();
  alert('Sesja zapisana (Premium 4.3 ‚úÖ)');
}

// --- Historia sesji ---
function renderHistory(){
  historyDiv.innerHTML = '';
  if(!sessions.length){
    historyDiv.innerHTML = '<div class="small">Brak zapisanych sesji.</div>';
    return;
  }
  const last = [...sessions].sort((a,b)=> parseDate(b.date) - parseDate(a.date)).slice(0,30);
  last.forEach(s=>{
    const div = document.createElement('div');
    div.className = 'history-item';
    const date = s.date;
    const label = s.planLabel || s.planId;
    const kcalTxt = s.kcal ? `${s.kcal} kcal${s.kcalFromWatch ? ' (AW)' : ''}` : '‚Äì';
    const hrTxt = s.avgHr ? `HR: ${s.avgHr}${s.maxHr ? ' / '+s.maxHr : ''}` : '';
    const durTxt = s.durationMin ? `Czas: ${s.durationMin} min` : '';

    div.innerHTML = `
      <div>
        <div class="small"><strong>${date}</strong> ‚Ä¢ ${label}</div>
        <div class="small">
          Objƒôto≈õƒá: ${Math.round(s.totalVolume)} kg ‚Ä¢ 
          Kcal: <span class="kcal">${kcalTxt}</span>
          ${durTxt ? ' ‚Ä¢ '+durTxt : ''}
          ${hrTxt ? ' ‚Ä¢ '+hrTxt : ''}
        </div>
      </div>
      <div class="history-buttons">
        <button class="btn-ghost btn-small details-btn" data-id="${s.id}">Szczeg√≥≈Çy</button>
        <button class="btn-primary btn-small load-btn" data-id="${s.id}">Za≈Çaduj</button>
      </div>
    `;
    historyDiv.appendChild(div);
  });

  elAll('.details-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> showSessionDetails(parseInt(btn.getAttribute('data-id'))));
  });
  elAll('.load-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> loadSessionToForm(parseInt(btn.getAttribute('data-id'))));
  });
}

function showSessionDetails(id){
  const s = sessions.find(x=>x.id===id);
  if(!s) return;
  let msg = `Data: ${s.date}\nPlan: ${s.planLabel}\nWaga cia≈Ça: ${s.bodyWeight || '-'} kg\n`;
  msg += `Kcal: ${s.kcal}${s.kcalFromWatch ? ' (z Apple Watch)' : ' (szacowane)'}\n`;
  if(s.durationMin) msg += `Czas: ${s.durationMin} min\n`;
  if(s.avgHr) msg += `≈örednie HR: ${s.avgHr}\n`;
  if(s.maxHr) msg += `Maks HR: ${s.maxHr}\n`;
  msg += `Objƒôto≈õƒá: ${Math.round(s.totalVolume)} kg\n\nƒÜwiczenia:\n`;
    (s.exercises || []).forEach(ex=>{
    msg += `- ${ex.name}\n`;
    (ex.sets || []).forEach(st=>{
      const planTxt = st.repsPlannedText || (typeof st.repsPlanned === 'number' ? st.repsPlanned : '');
      const doneTxt = (typeof st.repsDone === 'number' ? st.repsDone : '');
      msg += `   S${st.set}: ${st.weight || 0} kg x ${doneTxt || '-'} (plan: ${planTxt || '-'}) ${st.done ? '‚úì' : ''}\n`;
    });
  });
  alert(msg);
}

// --- ≈Åadowanie sesji do formularza ---
function loadSessionToForm(id){
  const s = sessions.find(x=>x.id===id);
  if(!s) return;

  if(plans[s.planId]){
    sessionType.value = s.planId;
    planSelect.value = s.planId;
    renderPlan(sessionType.value);
    renderPlanEditor();
  }
  sessionDate.value = s.date;

  el('#bodyWeight').value = s.bodyWeight || '';
  el('#sessionKcal').value = s.kcalFromWatch || '';
  el('#avgHr').value = s.avgHr || '';
  el('#maxHr').value = s.maxHr || '';
  el('#durationMin').value = s.durationMin || '';

  const plan = plans[s.planId];
  if(plan){
    (plan.exercises || []).forEach((ex, idx)=>{
      const sEx = (s.exercises || [])[idx];
      if(!sEx) return;
            (sEx.sets || []).forEach(st=>{
        const wInput = el(`input.weight-input[data-ex="${idx}"][data-set="${st.set}"]`);
        const rInput = el(`input.reps-input[data-ex="${idx}"][data-set="${st.set}"]`);
        const cb     = el(`input.checkbox[data-ex="${idx}"][data-set="${st.set}"]`);
        if(wInput) wInput.value = st.weight || '';
        if(rInput) rInput.value = (typeof st.repsDone === 'number' && st.repsDone > 0) ? st.repsDone : '';
        if(cb){
          cb.checked = !!st.done;
          updateSetRowStyle(cb);
        }
      });

    });
    updateProgress();
  }

  renderCalendarAndStats();
  alert('Sesja za≈Çadowana do formularza ‚úÖ');
}

loadLastBtn.addEventListener('click', ()=>{
  if(!sessions.length){
    alert('Brak zapisanych sesji.');
    return;
  }
  const last = [...sessions].sort((a,b)=> parseDate(b.date) - parseDate(a.date))[0];
  loadSessionToForm(last.id);
});
if(exportBtn){
  exportBtn.addEventListener('click', exportData);
}
if(importBtn){
  importBtn.addEventListener('click', importData);
}

// --- Kalendarz tygodniowy + statystyki ---
function getWeekRange(baseDateStr){
  const d = baseDateStr ? parseDate(baseDateStr) : new Date();
  const day = d.getDay(); // 0 = niedziela
  const diffToMonday = (day + 6) % 7;
  const monday = new Date(d);
  monday.setDate(d.getDate() - diffToMonday);
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);

  return {
    monday,
    sunday,
    mondayStr: formatLocalDate(monday),
    sundayStr: formatLocalDate(sunday)
  };
}

function renderCalendarAndStats(){
  const baseDateStr = sessionDate.value || formatLocalDate(new Date());
  const {monday, sunday} = getWeekRange(baseDateStr);

  let html = '<div class="badge"><span class="badge-dot"></span><span>Bie≈ºƒÖcy tydzie≈Ñ</span></div>';
  html += '<div class="week-grid">';
  for(let i=0;i<7;i++){
    const dayDate = new Date(monday);
    dayDate.setDate(monday.getDate()+i);
    const dStr = formatLocalDate(dayDate);
    const daySessions = sessions.filter(s=>s.date===dStr);
    const dayName = ['Pn','Wt','≈ör','Cz','Pt','So','Nd'][i];
    const totalVol = daySessions.reduce((acc,s)=>acc+s.totalVolume,0);
    const intensityClass = totalVol===0 ? '' : (totalVol<2000?'yellow':'green');

    html += `<div class="week-day">
      <strong>${dayName}</strong>
      <span>${dStr.slice(5)}</span>`;
    if(!daySessions.length){
      html += `<span class="small">Brak treningu</span>`;
    }else{
      daySessions.forEach(s=>{
        html += `<div class="tag">${s.planLabel || s.planId}</div>`;
      });
      if(totalVol>0){
        html += `<div class="small ${intensityClass}">Objƒôto≈õƒá: ${Math.round(totalVol)} kg</div>`;
      }
    }
    html += `</div>`;
  }
  html += '</div>';
  calendarWeekDiv.innerHTML = html;

  const weekSessions = sessions.filter(s=>{
    const d = parseDate(s.date);
    return d>=monday && d<=sunday;
  });

  const now = baseDateStr ? parseDate(baseDateStr) : new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const monthSessions = sessions.filter(s=>{
    const d = parseDate(s.date);
    return d.getFullYear()===year && d.getMonth()===month;
  });
// --- Roczne statystyki ---
const yearSessionsAll = sessions.filter(s=>{
  const d = parseDate(s.date);
  return d.getFullYear() === year;
});

const yearVolume = yearSessionsAll.reduce((acc, s) => acc + s.totalVolume, 0);
const yearKcal   = yearSessionsAll.reduce((acc, s) => acc + (s.kcal || 0), 0);

  const weekVolume = weekSessions.reduce((acc,s)=>acc+s.totalVolume,0);
  const weekKcal = weekSessions.reduce((acc,s)=>acc+(s.kcal||0),0);
  const monthVolume = monthSessions.reduce((acc,s)=>acc+s.totalVolume,0);
  const monthKcal = monthSessions.reduce((acc,s)=>acc+(s.kcal||0),0);

  const bwSessions = sessions.filter(s=>s.bodyWeight);
  const lastBw = bwSessions.length ? bwSessions[bwSessions.length-1].bodyWeight : null;

  let statsHtml = '';
  statsHtml += `<div class="stats">
    <div class="stat-row">
      <span>Tydzie≈Ñ ‚Äì ilo≈õƒá trening√≥w</span>
      <span><strong>${weekSessions.length}</strong></span>
    </div>
    <div class="stat-row">
      <span>Tydzie≈Ñ ‚Äì objƒôto≈õƒá</span>
      <span><strong>${Math.round(weekVolume)} kg</strong></span>
    </div>
    <div class="stat-row">
      <span>Tydzie≈Ñ ‚Äì kcal (szac. / AW)</span>
      <span class="kcal">${weekKcal} kcal</span>
    </div>
    <div class="stat-row">
      <span>MiesiƒÖc ‚Äì ilo≈õƒá trening√≥w</span>
      <span><strong>${monthSessions.length}</strong></span>
    </div>
    <div class="stat-row">
      <span>MiesiƒÖc ‚Äì objƒôto≈õƒá</span>
      <span><strong>${Math.round(monthVolume)} kg</strong></span>
    </div>
    <div class="stat-row">
      <span>MiesiƒÖc ‚Äì kcal (szac. / AW)</span>
      <span class="kcal">${monthKcal} kcal</span>
    </div>
    <div class="stat-row">
      <span>Rok ‚Äì ilo≈õƒá trening√≥w</span>
      <span><strong>${yearSessionsAll.length}</strong></span>
    </div>
    <div class="stat-row">
      <span>Rok ‚Äì objƒôto≈õƒá</span>
      <span><strong>${Math.round(yearVolume)} kg</strong></span>
    </div>
    <div class="stat-row">
      <span>Rok ‚Äì kcal</span>
      <span class="kcal">${yearKcal} kcal</span>
    </div>
<div class="stat-row">
      <span>Ostatnia waga cia≈Ça</span>
      <span><strong>${lastBw ? lastBw.toFixed(1)+' kg' : '-'}</strong></span>
    </div>
  </div>`;
  statsWeekDiv.innerHTML = statsHtml;
}

// --- Wykresy ---
function updateCharts(){
  const byDate = {};
  sessions.forEach(s=>{
    if(!byDate[s.date]) byDate[s.date] = {volume:0, bodyWeights:[]};
    byDate[s.date].volume += s.totalVolume;
    if(s.bodyWeight) byDate[s.date].bodyWeights.push(s.bodyWeight);
  });
  const dates = Object.keys(byDate).sort();
  const volumes = dates.map(d=> Math.round(byDate[d].volume));
  const weights = dates.map(d=>{
    const arr = byDate[d].bodyWeights;
    if(!arr.length) return null;
    return arr.reduce((a,b)=>a+b,0)/arr.length;
  });

  const ctxVol = document.getElementById('chartVolume').getContext('2d');
  const ctxBw = document.getElementById('chartWeight').getContext('2d');

  if(chartVolume) chartVolume.destroy();
  if(chartWeight) chartWeight.destroy();

  chartVolume = new Chart(ctxVol, {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [{
        label: 'Objƒôto≈õƒá (kg)',
        data: volumes
      }]
    },
    options: {
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{x:{ticks:{autoSkip:true,maxTicksLimit:6}},y:{beginAtZero:true}}
    }
  });

  chartWeight = new Chart(ctxBw, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Waga cia≈Ça (kg)',
        data: weights
      }]
    },
    options: {
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{x:{ticks:{autoSkip:true,maxTicksLimit:6}},y:{beginAtZero:false}}
    }
  });
}
function resetAfterSave(){
  // 1) prze≈Çadowanie planu ‚Äì dok≈Çadnie jak po od≈õwie≈ºeniu strony
  renderPlan(sessionType.value);

  // 2) wyczyszczenie danych sesji
  ['#sessionKcal', '#avgHr', '#maxHr', '#durationMin', '#bodyWeight', '#restTime'].forEach(sel=>{
    const input = el(sel);
    if(input) input.value = '';
  });

  // 3) wyzerowanie timera
  clearInterval(timerInterval);
  timerDisplay.textContent = '0s';
}
function exportData(){
  const payload = {
    version: 'tt_premium_4.3',
    exportedAt: new Date().toISOString(),
    plans,
    sessions
  };
  const json = JSON.stringify(payload, null, 2);

  try{
    const blob = new Blob([json], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'trening-tracker-backup.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }catch(e){
    console.error(e);
    // fallback ‚Äì jakby blob/downloader nie zadzia≈Ça≈Ç
    prompt('Nie uda≈Ço siƒô automatycznie pobraƒá pliku. Skopiuj ten JSON:', json);
  }
}

function importData(){
  const input = prompt('Wklej JSON wyeksportowany z Trening Tracker:');
  if(!input) return;

  try{
    const parsed = JSON.parse(input);

    if(parsed.plans && typeof parsed.plans === 'object'){
      plans = parsed.plans;
      savePlans();
    }
    if(Array.isArray(parsed.sessions)){
      sessions = parsed.sessions;
      saveSessions();
    }

    // od≈õwie≈º UI po imporcie
    refreshPlanSelects();
    if(sessionType.options.length) sessionType.value = sessionType.options[0].value;
    if(planSelect.options.length) planSelect.value = planSelect.options[0].value;

    renderPlan(sessionType.value);
    renderPlanEditor();
    renderHistory();
    renderCalendarAndStats();
    updateCharts();

    alert('Dane zaimportowane ‚úÖ');
  }catch(e){
    console.error(e);
    alert('B≈ÇƒÖd importu JSON. Sprawd≈∫, czy wklei≈Çe≈õ poprawne dane.');
  }
}


// --- Edytor plan√≥w ---
function renderPlanEditor(){
  const id = planSelect.value;
  const plan = plans[id];
  if(!plan){
    planEditorArea.innerHTML = '<div class="small">Brak planu.</div>';
    return;
  }
  let html = `<div class="small" style="margin-bottom:4px;">
    Nazwa planu: <input type="text" id="planLabelInput" class="input" style="width:60%;margin-top:4px" value="${plan.label}">
  </div>`;
  html += `<table style="width:100%;margin-top:6px">
    <thead><tr><th>ƒÜwiczenie</th><th>Serie</th><th>Powt.</th><th>Partia</th><th></th></tr></thead><tbody>`;
  (plan.exercises || []).forEach((ex, idx)=>{
    html += `<tr>
      <td>
  <div style="display:flex; gap:4px;">
    <input type="text" class="input ex-name" data-idx="${idx}" value="${ex.name}" style="flex:1">
    <button class="btn-ghost btn-small pick-ex" data-idx="${idx}">üìö</button>
  </div>
</td>
      <td><input type="number" class="input ex-sets" data-idx="${idx}" value="${ex.sets}" style="width:60px"></td>
      <td><input type="text" class="input ex-reps" data-idx="${idx}" value="${ex.reps}" style="width:80px"></td>
      <td><input type="text" class="input ex-muscle" data-idx="${idx}" value="${ex.muscle||''}" style="width:80px"></td>
      <td><button class="btn-ghost btn-small remove-ex" data-idx="${idx}">X</button></td>
    </tr>`;
  });
    html += `</tbody></table>`;
  planEditorArea.innerHTML = html;

  elAll('.remove-ex').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = parseInt(btn.getAttribute('data-idx'));
      plan.exercises.splice(idx,1);
      savePlans();
      renderPlanEditor();
      renderPlan(sessionType.value);
    });
  });

  elAll('.pick-ex').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = parseInt(btn.dataset.idx);
      openExercisePicker(idx);
    });
  });
}
// --- Picker ƒáwicze≈Ñ ---
function openExercisePicker(idx){
  const search = prompt("Wyszukaj ƒáwiczenie (nazwa / partia):", "");
  const q = (search || "").toLowerCase();

  const filtered = exercises.filter(ex =>
    ex.name.toLowerCase().includes(q) ||
    ex.muscle.toLowerCase().includes(q)
  );

  if(!filtered.length){
    alert("Brak ƒáwicze≈Ñ pasujƒÖcych do wyszukania.");
    return;
  }

  let msg = "Wybierz numer ƒáwiczenia:\n\n";
  filtered.forEach((ex,i)=>{
    msg += `${i+1}. ${ex.name} (${ex.muscle})\n`;
  });

  const pick = parseInt(prompt(msg, "1")) - 1;
  if(pick < 0 || pick >= filtered.length) return;

  const chosen = filtered[pick];
  const input = el(`.ex-name[data-idx="${idx}"]`);
  const muscleInput = el(`.ex-muscle[data-idx="${idx}"]`);
  if(input) input.value = chosen.name;
  if(muscleInput) muscleInput.value = chosen.muscle;
}


el('#newPlanBtn').addEventListener('click', ()=>{
  const name = prompt('Nazwa nowego planu (np. Push, Full Body itp.):','Nowy plan');
  if(!name) return;
  const id = 'CUST_'+Date.now();
  plans[id] = {
    id,
    label: name,
    warmup: '10 min dowolne cardio - rozgrzewka',
    exercises: []
  };
  savePlans();
  refreshPlanSelects();
  planSelect.value = id;
  sessionType.value = id;
  renderPlanEditor();
  renderPlan(sessionType.value);
});

planSelect.addEventListener('change', ()=>{
  renderPlanEditor();
  sessionType.value = planSelect.value;
  renderPlan(sessionType.value);
});

el('#addExerciseBtn').addEventListener('click', ()=>{
  const id = planSelect.value;
  const plan = plans[id];
  if(!plan) return;
  plan.exercises.push({
    name:'Nowe ƒáwiczenie',
    sets:3,
    reps:'8-12',
    muscle:''
  });
  savePlans();
  renderPlanEditor();
  renderPlan(sessionType.value);
});

el('#savePlanBtn').addEventListener('click', ()=>{
  const id = planSelect.value;
  const plan = plans[id];
  if(!plan) return;
  const labelInput = el('#planLabelInput');
  if(labelInput) plan.label = labelInput.value || plan.label;

  const names = elAll('.ex-name');
  const sets = elAll('.ex-sets');
  const reps = elAll('.ex-reps');
  const muscles = elAll('.ex-muscle');

  const newEx = [];
  for(let i=0;i<names.length;i++){
    const n = names[i].value.trim();
    if(!n) continue;
    const s = parseInt(sets[i].value)||1;
    const r = reps[i].value.trim() || '8-12';
    const m = muscles[i].value.trim();
    newEx.push({name:n, sets:s, reps:r, muscle:m});
  }
  plan.exercises = newEx;
  savePlans();
  refreshPlanSelects();
  sessionType.value = id;
  alert('Plan zapisany ‚úÖ');
  renderPlan(sessionType.value);
});

// --- MOBILE SEKCJE / NAV ---
function initMobileSections(){
  const sections = document.querySelectorAll('.mobile-section');
  const buttons = document.querySelectorAll('.mobile-nav-btn');
  if (!sections.length || !buttons.length) return;

  sections.forEach(sec=>{
    sec.classList.toggle('active', sec.dataset.section === 'workout');
  });

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target = btn.dataset.section;
      buttons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      sections.forEach(sec=>{
        sec.classList.toggle('active', sec.dataset.section === target);
      });
    });
  });
}

// --- Zdarzenia ---
sessionType.addEventListener('change', ()=>{
  renderPlan(sessionType.value);
});
sessionDate.addEventListener('change', ()=>{
  renderCalendarAndStats();
});
saveBtn.addEventListener('click', saveSession);

// --- Start: inicjalizacja ---
(function init(){
  plans = loadPlans();
  sessions = loadSessions();
  exercises = loadExercises();
  
  sessionDate.value = formatLocalDate(new Date());
  refreshPlanSelects();
  if(sessionType.options.length) sessionType.value = sessionType.options[0].value;
  if(planSelect.options.length) planSelect.value = planSelect.options[0].value;

  renderPlan(sessionType.value);
  renderPlanEditor();
  renderHistory();
  renderCalendarAndStats();
  updateCharts();
  initMobileSections();
})();
</script>
</body>
</html>
